.MAIN.	MACRO V05.06R Wednesday 16-Oct-19 11:07  Page 1


      1					;.enabl	ama
      2					;.ASECT
      3					        .list meb
      4
      5					        .MCall  .Exit, .Print
      6	000000				TEST:
      7	000000	000167 	000372 		        JMP     START
      8					;         . = 0074
      9	000004	000167 	000400 		LAUNCH: JMP     EXIT
     10
     11					;         . = 0122
     12	000010				         .blkb   0112
     13	000122				UNLZ4:
     14					; ------------------------------
     15	000122	012705 	000426'		        MOV     #dst, R5
     16	000126	012700 	002376'		        MOV     #src, R0
     17	000132	012704 	177774 		        MOV     #-4,  R4        ; Ќет лучше места под константу -4, чем R4
     18
     19	000136	005002 			        CLR     R2
     20	000140				gettoken:
     21	000140	152002 			        BISB    (R0)+, R2       ; (на входе всегда R2=0), считываем
     22	000142	010201 			        MOV     R2, R1          ; байт-токен без знакового расширени€
     23
     24	000144	072104 			        ASH     R4, R1          ; —тарший полубайт - число литералов
     25	000146	001442 			        BEQ     noliterals      ; Ћитералов может и не быть...
     26	000150	022701 	000017 		        CMP     #^X0f, R1       ; ѕризнак большой длины?
     27	000154	001005 			        BNE     copylits
     28	000156	005003 			          CLR     R3
     29	000160	152003 			1$:         BISB  (R0)+, R3     ; ”точн€ем длину...
     30	000162	060301 			            ADD   R3, R1
     31	000164	105203 			            INCB  R3            ; бесконечно долго, пока приход€т 0xFF
     32	000166	001774 			            BEQ   1$
     33
     34	000170				copylits:
     35	000170	005301 			          DEC     R1
     36	000172	010103 			          MOV     R1, R3
     37	000174	072104 			          ASH     R4, R1
     38	000176	005201 			          INC     R1
     39	000200	005103 			          COM     R3
     40	000202	042703 	177760 		          BIC     #^X0fff0, R3
     41	000206	060303 			          ADD     R3, R3
     42	000210	060307 			          ADD     R3, PC
     43	000212				3$:
     44		000020 			          .rept  16.
     45					          MOVB  (R0)+, (R5)+    ;  опируем литералы
     46					          .endr
	000212	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000214	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000216	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000220	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000222	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000224	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000226	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000230	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000232	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000234	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000236	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
.MAIN.	MACRO V05.06R Wednesday 16-Oct-19 11:07  Page 1-1


	000240	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000242	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000244	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000246	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
	000250	112025 			          MOVB  (R0)+, (R5)+    ; копируем литералы
     47	000252	077121 			          SOB     R1, 3$
     48
     49	000254				noliterals:
     50	000254	012003 			        MOV     (R0)+, R3       ; ѕолучаем два байт смещени€
     51	000256	001652 			        BEQ     LAUNCH          ; Ќулевое смещение - конец сжатого блока
     52					                                ; R1=0, как бы мы сюда не попали
     53	000260	042702 	177760 		        BIC     #^X0fff0, R2    ; ћладший полубайт - число копируемых байт
     54	000264	022702 	000017 		        CMP     #^X0f, R2       ; ѕризнак большой длины?
     55	000270	001004 			        BNE     shortstr
     56	000272	152001 			2$:       BISB  (R0)+, R1       ; ”точн€ем длину...
     57	000274	060102 			          ADD   R1, R2
     58	000276	105201 			          INCB  R1              ; бесконечно долго, пока приход€т 0xFF
     59	000300	001774 			          BEQ   2$
     60	000302				shortstr:
     61	000302	160402 			        SUB     R4, R2          ; ћинимальный размер строки - 4 байта
     62	000304	010501 			        MOV     R5, R1
     63	000306	160301 			        SUB     R3, R1
     64	000310				copystr:
     65	000310	005302 			          DEC     R2
     66	000312	010203 			          MOV     R2, R3
     67	000314	072204 			          ASH     R4, R2
     68	000316	005202 			          INC     R2
     69	000320	005103 			          COM     R3
     70	000322	042703 	177760 		          BIC     #^X0fff0, R3
     71	000326	060303 			          ADD     R3, R3
     72	000330	060307 			          ADD     R3, PC
     73	000332				4$:
     74		000020 			          .rept  16.
     75					          MOVB  (R1)+, (R5)+    ;  опируем строку из
     76					          .endr
	000332	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000334	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000336	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000340	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000342	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000344	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000346	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000350	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000352	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000354	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000356	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000360	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000362	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000364	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000366	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
	000370	112125 			          MOVB  (R1)+, (R5)+    ; копируем строку из
     77	000372	077221 			          SOB   R2, 4$          ; уже распакованных данных
     78	000374	000661 			        BR      gettoken
     79					; ------------------------------
     80
     81	000376				START:  .Print  #msg1
	000376	012700 	002447'			MOV	#msg1,R0
.MAIN.	MACRO V05.06R Wednesday 16-Oct-19 11:07  Page 1-2


	000402	104351 				EMT	^o<351>
     82	000404	000167 	177512 		        JMP     UNLZ4
     83
     84	000410				EXIT:
     85	000410					.Print  #msg2
	000410	012700 	002465'			MOV	#msg2,R0
	000414	104351 				EMT	^o<351>
     86	000416				        .Print  #dst
	000416	012700 	000426'			MOV	#dst,R0
	000422	104351 				EMT	^o<351>
     87	000424				        .Exit
	000424	104350 				EMT	^o350
     88
     89	000426				dst:    .blkb   1000.
     90
     91					; —жатые данные дл€ проверки
     92		000020 			        .radix  16
     93
     94	002376	   162 			src:    .byte   72              ; ƒалее 7 литералов и копируем строку из 6 символов
     95	002377	   110 	   145 	   154 	        .ascii  "Hello !"
	002402	   154 	   157 	   040
	002405	   041
     96	002406	   001 	   000 		        .byte   1, 0            ; —мещение -1
     97
     98	002410	   037 			        .byte   1f              ; ƒва литерала и копируем строку из:
     99	002411	   077 			        .ascii  "?"
    100	002412	   002 	   000 		        .byte   2, 0            ; (—мещение -2)
    101	002414	   377 			        .byte   0ff
    102	002415	   012 			        .byte   0a              ;                                    15+10 = 25 байт
    103
    104	002416	   360 			        .byte   0F0             ; ƒалее 21 литерал и ничего уже не копируем (нулевое смещение)
    105	002417	   006 			        .byte   6               ; (20-14)
    106	002420	   115 	   145 	   144 	        .ascii  "Medved privet v obed"
	002423	   166 	   145 	   144
	002426	   040 	   160 	   162
	002431	   151 	   166 	   145
	002434	   164 	   040 	   166
	002437	   040 	   157 	   142
	002442	   145 	   144
    107	002444	   000 			        .byte   0               ; Ќулевой байт - конец строки
    108	002445	   000 	   000 		        .byte   0, 0            ; Ќулевое смещение - признак конца сжатых данных
    109
    110	002447	   125 	   156 	   160 	msg1:    .asciz "Unpacking... "
	002452	   141 	   143 	   153
	002455	   151 	   156 	   147
	002460	   056 	   056 	   056
	002463	   040 	   000
    111	002465	   144 	   157 	   156 	msg2:    .asciz "done "
	002470	   145 	   040 	   000
    112
    113		000000'			.End    TEST
.MAIN.	MACRO V05.06R Wednesday 16-Oct-19 11:07  Page 1-3
Symbol table

COPYLI  000170R  	EXIT    000410R  	MSG1    002447R  	SHORTS  000302R  	TEST    000000R
COPYST  000310R  	GETTOK  000140R  	MSG2    002465R  	SRC     002376R  	UNLZ4   000122R
DST     000426R  	LAUNCH  000004R  	NOLITE  000254R  	START   000376R  	...V1 = 000003


. ABS.	000000    000	(RW,I,GBL,ABS,OVR)
      	002473    001	(RW,I,LCL,REL,CON)
Errors detected:  0

*** Assembler statistics


Work  file  reads: 0
Work  file writes: 0
Size of work file: 10613 Words  ( 42 Pages)
Size of core pool: 16640 Words  ( 65 Pages)
Operating  system: RT-11

Elapsed time: 00:00:00.03
DK:UNLZ43,DK:UNLZ43=DK:UNLZ43
